{% extends "todo/base.html" %}

{% block title %}Task List{% endblock %}

{% block content %}
<h1 class="mb-4">Task List</h1>
<a href="{% url 'task_create' %}" class="btn btn-primary mb-3">Create Task</a>
<ul class="list-group">
    {% for task in tasks %}
    <li class="list-group-item d-flex justify-content-between align-items-center">
        <div>
            <span class="task-color" style="background-color: {{ task.color }}"></span>
            <strong>{{ task.title }}</strong>
            <div>Start time: {{ task.start_time }}</div>
            <div>End time: {{ task.end_time }}</div>
            <div>Category: {{ task.category.name }}</div>
            <div>Status: {{ task.get_status_display }}</div>
            <div>Time left: <span id="time-left-{{ task.pk }}"></span></div>
        </div>
        <div>
            <a href="{% url 'task_update' task.pk %}" class="btn btn-warning btn-sm">Edit</a>
            <form action="{% url 'task_delete' task.pk %}" method="post" class="d-inline">
                {% csrf_token %}
                <button type="submit" class="btn btn-danger btn-sm">Delete</button>
            </form>
        </div>
    </li>
    {% endfor %}
</ul>

<script>
function updateTimeLeft() {
    const now = new Date();
    {% for task in tasks %}
    const endTime = new Date('{{ task.end_time|date:"Y-m-d\TH:i:s" }}Z');
    const timeLeft = endTime - now;
    const seconds = Math.floor((timeLeft / 1000) % 60);
    const minutes = Math.floor((timeLeft / 1000 / 60) % 60);
    const hours = Math.floor((timeLeft / 1000 / 60 / 60) % 24);
    const days = Math.floor(timeLeft / 1000 / 60 / 60 / 24);

    const timeLeftElement = document.getElementById('time-left-{{ task.pk }}');
    if (timeLeftElement) {
        timeLeftElement.innerHTML = `${days}d ${hours}h ${minutes}m ${seconds}s`;
    }
    {% endfor %}
}

document.addEventListener('DOMContentLoaded', function() {
    setInterval(updateTimeLeft, 1000);
});
</script>
{% endblock %}
